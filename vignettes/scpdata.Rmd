--- 
title: "The single cell proteomics data package"
author:
- name: Christophe Vanderaa
  affiliation: Computational Biology, UCLouvain
- name: Laurent Gatto
  affiliation: Computational Biology, UCLouvain
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document:
    toc_float: true
vignette: >
  %\VignetteIndexEntry{scpdata}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

```{r style, echo = FALSE, results = 'asis'}
BiocStyle::markdown()
```

```{r, echo = FALSE}
suppressPackageStartupMessages(library(MSnbase))
suppressPackageStartupMessages(library(magrittr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(reshape2))
suppressPackageStartupMessages(library(sva))

suppressPackageStartupMessages(library(scpdata))
# source("../R/specht2019_funs.R")
```

# Introduction 



# Dou et al. 2019 




# Specht et al. 2019

We will show some quality control figures and processing steps for the single cell data set produced by Specht and colleagues (Specht et al. 2019). Information about the data set can be found in `scpdata/inst/README.md` or in the data set help file: 

```{r data_info}
library(scpdata)
?specht2019
```

Reference: *Specht, Harrison, Emmott, Koller, Slavov. 2019. “High-Throughput Single-Cell Proteomics Quantifies the Emergence of Macrophage Heterogeneity.” bioRxiv. https://doi.org/10.1101/665307.*

We first store our data set in the `sc` variable. 

```{r loading_data}
sc <- specht2019
```


## Data exploration

The most straightforward way to look at single-cell data is the heatmap:

```{r heatmap, echo = FALSE}
show_heatmap(sc)
```

Here are some basic summary statistics 

```{r basic_stat}
scp_plotStats(sc, xstat = "median", ystat = "sd")
``` 

Let's check the missingness of the data 

```{r missingness}
scp_plotMissing(sc)
```

A popular measure of quality is the coefficient of variation (*i.e.* the standard deviation over the mean intensity)

```{r variation}
scp_plotCV(sc)
```




## Normalization 

The normalization procedure here follows the normalization procedure from the original paper. The first step is to subtract from each row (peptides) the mean intensity of that row. This is performed using our `scp_normalize()` function.

```{r peptide_normalization, echo = TRUE, include=TRUE}
scNorm <- scp_normalize(sc, what = "row")
```

Next, the rows are collapsed by proteins, meaning that measurements for peptides that belong to the same proteins are merged in a single rozw. The rows from different peptides are summarized using the median value of the peptides.

```{r peptide_aggregation}
scNorm <- scp_aggregateByProtein(scNorm)
```

Rows than columns are finally normalized again. For the rows the **mean** value is subtracted; for the columns the **median** value is subtracted. Note that the argument `"both"` implies that rows then colmuns are normalized.

```{r protein_cell_normalization}
scNorm <- scp_normalize(scNorm, what = "both")
```

This can be performed in a single run using pipes:
```{r normalization_pipe, eval = FALSE}
sc %>% scp_normalize(what = "row") %>%
       scp_aggregateByProtein() %>%
       scp_normalize(what = "both") -> scNorm
```


## Imputation 

The `specht2019` data set is highly sparse it contains a majority of missing
entries. We can see this here:

```{r missing_data, echo = FALSE}
n.na <- sum(is.na(exprs(sc)))
n <- length(exprs(sc))
cat("Missing data:", round(n.na / n * 100, 2), "%")
```

Over **75%** of the data is missing ! This large proportion of missing data hinders downstream analysis and imputation is hence performed to fill in the gaps. In their paper, Specht et al. implemented the k-nearest neighbour imputation:

```{r imputation}
scImput <- imputeKNN(scNorm)
```

```{r filled_data, echo = FALSE}
n.na <- sum(is.na(exprs(scImput)))
cat("Missing data:", round(n.na / n * 100, 2), "%")
```

## Batch correction

Specht et al. performed batch correction of the single cell data using the `ComBat` function from the `sva` package. `ComBat` is a batch correction method using empirical Bayes (EB) procedure developed by Johnson et al. (2007) to remove variation linked to experimental variables (**eg** day of processing) while preserving the other sources of variation, namely the biological variation. The method is based on a previous model called the location and scale adjustment (L/S) model.

```{r batch_correction}
scBc <- batchCorrect(scImput, batch = "raw.file", target = "celltype")
```


## Quality control

Let's check how the normalization, imputation, and batch correction affects the data. 

### Normalization

Above, we looked at the mean and standard deviation distributions of the original data set. We can redraw those plots after data normalization:

```{r, echo = FALSE}
scp_plotStats(scNorm, xstat = "median", ystat = "sd")
```

The protein variance seems to be linked to the median intensity.

### Imputation

To asses imputation, we can have a look at single cell data as a heatmap. 
Before imputation (after normalization), the data looks like this:

```{r before_imput, echo = FALSE}
show_heatmap(scNorm)
```

After imputation:

```{r after_imput, echo = FALSE}
show_heatmap(scImput)
```

Since the distance measure used for the KNN is Euclidean distance, it is interesting to look at how the similarity between cells is affected by the imputation:

```{r correl_imput, echo = FALSE}
par(mfrow = c(1,2))

R <- as.matrix( dist(t(exprs(scNorm))))
image(R, xlab = "Cell index 1", ylab = "Cell index 2", main = "Before imputation", 
      useRaster = TRUE, axes = FALSE)

R <- as.matrix( dist(t(exprs(scImput))))
image(R, xlab = "Cell index 1", ylab = "Cell index 2", main = "After imputation", 
      useRaster = TRUE, axes = FALSE)

```

From the two plots above we can see the imputation increases the correlation that exist between 3 batches of cells. The batches are defined as the combination of **chromatographic batches???** and another **undocumented batch** (the batch could be retrieved from the file names...). This stringly suggests that the SCoPE2 pipeline is subject to batch effect that cannot be corrected by the normalization to the reference channel. Therefore, batch correction using `ComBat` is applied. 

```{r correl_batch_correction, echo = FALSE}
par(mfrow = c(1,2))

R <- as.matrix(dist(t(exprs(scBc))))
image(R, xlab = "Cell index 1", ylab = "Cell index 2", main = "Batch correction", 
      useRaster = TRUE, axes = FALSE)

R <- as.matrix( dist(t(exprs(scBc)[, order(pData(scBc)$celltype)])))
image(R, xlab = "Cell index 1", ylab = "Cell index 2", main = "Batch correction \n(cell type ordered)", 
      useRaster = TRUE, axes = FALSE)
```

It seems that the batch effects seen in the previous plots are completely removed. Second plot indicates that `ComBat` is able to correct for batch effects without affecting the biological variation induced by cell type. Note that here 62 batches (that is 62 SCoPE2 sets) were used for removing the batch effects.




